{% extends 'restaurant/base.html' %}

{% block title %}Book a Table - Little Lemon Restaurant{% endblock %}

{% block content %}
<section class="booking-section container my-5">
    <div class="row justify-content-center">
        <div class="col-md-8 col-lg-6">
            <h2 class="booking-title text-center mb-4">Book a Table</h2>
            <p class="booking-text text-center mb-4">
                Fill out the form below to reserve a table at Little Lemon Restaurant.
            </p>

            <!-- Success Alert -->
            {% if messages %}
                {% for message in messages %}
                    {% if message.tags == 'success' %}
                        <div class="alert alert-success alert-dismissible fade show" role="alert">
                            {{ message }}
                            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                        </div>
                    {% elif message.tags == 'error' %}
                        <div class="alert alert-danger alert-dismissible fade show" role="alert">
                            {{ message }}
                            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                        </div>
                    {% endif %}
                {% endfor %}
            {% endif %}

            <!-- Booking Form -->
            <form method="POST" id="booking-form" class="bg-light p-4 rounded shadow">
                {% csrf_token %}

                <!-- Guest Name -->
                <div class="form-group mb-3 text-start">
                    <label for="id_first_name" class="form-label">Guest Name:</label>
                    {{ form.first_name }}
                </div>

                <!-- Reservation Date -->
                <div class="form-group mb-3 text-start">
                    <label for="id_reservation_date" class="form-label">Reservation Date:</label>
                    <input type="text" id="id_reservation_date" name="reservation_date" class="form-control flatpickr-date" placeholder="Select a date" readonly>
                </div>

                <!-- Number of Guests -->
                <div class="form-group mb-3 text-start">
                    <label for="id_guests" class="form-label">Number of Guests:</label>
                    {{ form.guests }}
                </div>

                <!-- Time Slot Picker -->
                <div class="form-group mb-5 text-start custom-time-slot">
                    <label for="id_reservation_slot" class="form-label">Choose a Time Slot:</label>
                    <input type="text" id="id_reservation_slot" name="reservation_slot" class="form-control flatpickr-time" placeholder="Select a time slot" readonly>
                </div>

                <!-- Table Selector -->
                <div class="form-group mb-3 text-start">
                    <label for="id_table" class="form-label">Select Table:</label>
                    {{ form.table }} <!-- Ensure the table field is rendered here -->
                </div>

                <!-- Submit Button -->
                <div class="d-grid text-start">
                    <button type="submit" class="btn btn-primary btn-lg">Book Now</button>
                </div>
            </form>
        </div>
    </div>
</section>

<!-- Flatpickr CSS -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
<!-- Flatpickr Material Theme CSS -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/themes/material_blue.css">

<!-- Flatpickr JS -->
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>

<script>
    // Initialize Flatpickr for the date picker
    flatpickr("#id_reservation_date", {
        dateFormat: "Y-m-d", // Format the date as YYYY-MM-DD
        minDate: "today",    // Disable past dates
        defaultDate: "today", // Set the default date to today
        theme: "material_blue", // Use the Material Blue theme
        allowInput: true,    // Allow manual input
        altInput: true,      // Show a user-friendly date format in the input
        altFormat: "F j, Y", // Display format: e.g., "January 1, 2024"
    });

    // Initialize Flatpickr for the time picker
    flatpickr("#id_reservation_slot", {
        enableTime: true,    // Enable time selection
        noCalendar: true,    // Disable the calendar
        dateFormat: "H:i",   // Format the time as 24-hour (e.g., 14:00)
        time_24hr: true,     // Use 24-hour format
        minuteIncrement: 30, // Set time increments to 30 minutes
        minTime: "12:00",    // Earliest selectable time
        maxTime: "14:00",    // Latest selectable time
        defaultDate: "12:00", // Default selected time
        theme: "material_blue", // Use the Material Blue theme
    });

    const dateInput = document.querySelector('[name="reservation_date"]');
    const timeInput = document.querySelector('[name="reservation_slot"]');

    // Function to disable already booked slots and populate available ones
    function updateAvailableSlots(bookedSlots) {
        // Disable booked time slots in the time picker
        timeInput._flatpickr.set("disable", bookedSlots);
    }

    // Event listener for date change
    dateInput.addEventListener('change', function() {
        const selectedDate = dateInput.value;

        // Make an API call to get the booked slots for the selected date
        fetch(`/api/booked-slots/?date=${selectedDate}`)
            .then(response => response.json())
            .then(data => {
                const bookedSlots = data.booked_slots;
                updateAvailableSlots(bookedSlots);
            })
            .catch(error => console.error('Error fetching booked slots:', error));
    });

    // Automatically select the current date when the page loads
    document.querySelector('[name="reservation_date"]').value = new Date().toISOString().split('T')[0];
</script>

<!-- Bootstrap CSS and JS -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<style>
    /* Adjust height and padding for the Time Slot picker */
    .custom-time-slot input {
        height: 50px; /* Increase input height for better visibility */
        padding: 15px; /* Add more padding inside the input field */
    }
</style>

{% endblock %}
